var WASTE = [];
WASTE.length = 8;
WASTE[0] = [
  ['00', 39.2431787,-94.7370019,'1'],
  ['01', 39.2898592,-94.6863722,'1'],
  ['02', 39.2710242,-94.6678453,'1'],
  ['03', 39.2606268,-94.6623577,'1'],
  ['04', 39.263029,-94.7242035,'1'],
  ['05', 39.2727505,-94.6988655,'1'],
  ['06', 39.2789957,-94.6276975,'1'],
  ['07', 39.2351913,-94.7037787,'1'],
  ['08', 39.2298856,-94.6880157,'1'],
  ['09', 39.2305248,-94.6433863,'1'],
  ['10', 39.2382414,-94.6403928,'1'],
  ['11', 39.240959,-94.6552524,'1'],
  ['12', 39.2190493,-94.6909831,'1'],
  ['13', 39.2189333,-94.6482306,'1'],
  ['14', 39.2911898,-94.8058151,'1'],
];
WASTE[1] = [
  ['15', 39.2754468,-94.5993321,'2'],
  ['16', 39.2845263,-94.5833559,'2'],
  ['17', 39.2888818,-94.5630145,'2'],
  ['18', 39.2591714,-94.6400579,'2'],
  ['19', 39.2675453,-94.6154872,'2'],
  ['20', 39.265306,-94.5847927,'2'],
  ['21', 39.2632678,-94.5858203,'2'],
  ['22', 39.2574029,-94.5882033,'2'],
  ['23', 39.2518442,-94.586367,'2'],
  ['24', 39.2517741,-94.5729821,'2'],
  ['25', 39.2539061,-94.5667222,'2'],
  ['26', 39.2243489,-94.5813344,'2'],
  ['27', 39.2247728,-94.5554065,'2'],
  ['28', 39.2178903,-94.5419984,'2'],
  ['29', 39.1872093,-94.544712,'2']
];
WASTE[2] = [
  ['30', 39.1657878,-94.5902334,'3'],
  ['31', 39.2359789,-94.4959507,'3'],
  ['32', 39.3543179,-94.4260174,'3'],
  ['33', 39.3885007,-94.3448454,'3'],
  ['34', 39.4083557,-94.352175,'3'],
  ['35', 39.413057,-94.3715472,'3'],
  ['36', 39.4388803,-94.3393725,'3'],
  ['37', 39.4194278,-94.3163336,'3'],
  ['38', 39.3468861,-94.2767125,'3'],
  ['39', 39.3138709,-94.2923066,'3'],
  ['40', 39.2723572,-94.3552201,'3'],
  ['41', 39.265447,-94.3699433,'3'],
  ['42', 39.2541205,-94.3671224,'3'],
  ['43', 39.2228467,-94.4076589,'3'],
  ['44', 39.2149504,-94.3926815,'3'],
];
WASTE[3] = [
  ['45', 39.1990828,-94.8767134,'4'],
  ['46', 39.1491503,-94.8610692,'4'],
  ['47', 39.1006909,-94.8405625,'4'],
  ['48', 39.0785286,-94.8413468,'4'],
  ['49', 39.0358291,-94.7863306,'4'],
  ['50', 39.0411093,-94.7714265,'4'],
  ['51', 39.0377457,-94.762706,'4'],
  ['52', 39.0629461,-94.7348585,'4'],
  ['53', 39.1051807,-94.7177383,'4'],
  ['54', 39.1038394,-94.6711131,'4'],
  ['55', 39.0814747,-94.6713114,'4'],
  ['56', 39.0816183,-94.6528674,'4'],
  ['57', 39.1008603,-94.6423381,'4'],
  ['58', 39.1252578,-94.6217065,'4'],
  ['59', 39.1236686,-94.6212188,'4'],
];
WASTE[4] = [
  ['60', 39.1000706,-94.5940876,'5'],
  ['61', 39.1047656,-94.587772,'5'],
  ['62', 39.1031992,-94.5828907,'5'],
  ['63', 39.1242372,-94.5906439,'5'],
  ['64', 39.1120083,-94.5713383,'5'],
  ['65', 39.1050305,-94.5678021,'5'],
  ['66', 39.0976358,-94.5747986,'5'],
  ['67', 39.0814663,-94.5864272,'5'],
  ['68', 39.0862955,-94.5763322,'5'],
  ['69', 39.0849556,-94.5762812,'5'],
  ['70', 39.0627993,-94.5696039,'5'],
  ['71', 39.0705199,-94.5517173,'5'],
  ['72', 39.0893246,-94.5422069,'5'],
  ['73', 39.1091196,-94.5162243,'5'],
  ['74', 39.0468762,-94.5815972,'5'],
];
WASTE[5] = [
  ['75', 39.1105869,-94.4711014,'6'],
  ['76', 39.0886768,-94.4834321,'6'],
  ['77', 39.0837554,-94.4823369,'6'],
  ['78', 39.0823413,-94.5173375,'6'],
  ['79', 39.0599808,-94.5871244,'6'],
  ['80', 39.0627508,-94.5162774,'6'],
  ['81', 39.111187,-94.5396423,'6'],
  ['82', 39.083904,-94.5000264,'6'],
  ['83', 39.0765059,-94.5137466,'6'],
  ['84', 39.0554949,-94.4835117,'6'],
  ['85', 39.0706166,-94.431093,'6'],
  ['86', 39.0568098,-94.4224853,'6'],
  ['87', 39.0795022,-94.4186981,'6'],
  ['88', 39.1032805,-94.4469273,'6'],
  ['89', 39.0363955,-94.4414704,'6'],
];
WASTE[6] = [
  ['90', 38.9912292,-94.6836133,'7'],
  ['91', 38.9750091,-94.7086072,'7'],
  ['92', 38.977348,-94.7174573,'7'],
  ['93', 38.8931098,-94.7009274,'7'],
  ['94', 38.8873278,-94.7020264,'7'],
  ['95', 38.8846129,-94.700396,'7'],
  ['96', 38.899684,-94.685969,'7'],
  ['97', 38.9088063,-94.6453009,'7'],
  ['98', 38.9062818,-94.6400698,'7'],
  ['99', 38.9404039,-94.7381737,'7'],
  ['100', 38.8491518,-94.6570899,'7'],
  ['101', 39.0015376,-94.5861012,'7'],
  ['102', 38.9928591,-94.5714563,'7'],
  ['103', 38.9818346,-94.5682575,'7'],
  ['104', 38.9656586,-94.6055493,'7'],
];
WASTE[7] = [
  ['105', 39.0188667,-94.6252613,'8'],
  ['106', 39.0010317,-94.5814841,'8'],
  ['107', 38.9866629,-94.5655617,'8'],
  ['108', 38.9827959,-94.5675494,'8'],
  ['109', 38.9610732,-94.5917958,'8'],
  ['110', 38.9431893,-94.4491258,'8'],
  ['111', 38.9844884,-94.5126759,'8'],
  ['112', 38.9980997,-94.4805634,'8'],
  ['113', 38.9836225,-94.492455,'8'],
  ['114', 39.0148518,-94.4254242,'8'],
  ['115', 38.9997563,-94.4216776,'8'],
  ['116', 38.9710594,-94.5574532,'8'],
  ['117', 38.9745248,-94.5987889,'8'],
  ['118', 39.0090782,-94.469559,'8'],
  ['119', 38.981971,-94.5066791,'8'],
];

var UMKC = '39.1366392,-94.5229319';

var D = [];
D.length = 8;
for (var i = 0; i < D.length; i++) {
  D[i] = [];
  D[i].length = 16;
  for (var j = 0; j < D[i].length; j++) {
    D[i][j] = [];
    D[i][j].length = 16;
  }
}

$(document).ready(
  function() {
    if (sessionStorage.getItem('drivers') === null) {
      sessionStorage.setItem('drivers', 'Ting,Chen');
    }
    if (sessionStorage.getItem('id') === null) {
      sessionStorage.setItem('id', 'Dayu');
    }
    sessionStorage.setItem('stop', '1');
    sessionStorage.setItem('assign', '1');
    $('#supervisor').replaceWith('<td id = \'supervisor\' class = \'m_2\'>' + sessionStorage.getItem('id') + '</td>');
    var drivers = sessionStorage.getItem('drivers');
    drivers = drivers.split(',');
    var receivers = '<datalist id = \'job_receiver\'>';
    for (var i = 0; i < drivers.length; i++) {
      receivers += '<option value = "' + drivers[i] + '"></option>';
    }
    receivers += '</datalist>';
    $('#job_receiver').replaceWith(receivers);

    for (var q = 0; q < 1; q++) {
      (function() {
        for (var region = 0; region < 8; region++) {
          (function() {
            for (var source = 0; source < 16; source++) {
              (function() {
                routine_path_2(region, source, D[region]);
              })(source);
            }
          })(region)
        }
      })(q)
    }

    $(document).ajaxStop(
      function() {
        if (sessionStorage.getItem('stop') === '1') {
          sessionStorage.setItem('stop', '0');
          for (var k = 0; k < 8; k++) {
            var path = routine_path(D[k]);
            //      console.log(D[k]);
            //      console.log(path);
            for (var p = 0; p < path.length; p++) {
              if (p === 0) {
                $('#r' + (k + 1).toString()).append('&emsp;');
              }
              $('#r' + (k + 1).toString()).append((path[p] + 15 * k).toString());
              if (p !== path.length - 1) {
                $('#r' + (k + 1).toString()).append('&rarr;');
              }
            }
          }
        }
      }
    );
  }
);

var routine_path = function(region) {
  var result = [];
  var color = [];
  color.length = 16;
  for (var i = 0; i < 16; i++) {
    color[i] = 'white';
  }
  var queue = [];
  queue.push(0);
  color[0] = 'black';
  while (queue.length > 0) {
    var T = queue[0];
    queue.pop();
    var dist = Infinity;
    var ind;
    for (var j = 0; j < 16; j++) {
      if (color[j] === 'white' && region[T][j] < dist) {
        dist = region[T][j];
        ind = j;
      }
    }
    if (isFinite(dist)) {
      result.push(ind - 1);
      queue.push(ind);
      color[ind] = 'black';
    }
  }
  return result;
};

$(
  function() {
    $('#assign_job').click(
      function() {
        var job_type = $('#job_t').val();
        if (job_type === 'Routine Job') {
          var reg = $('#region_num').val();
          var receiver = $('#job_r').val();
          reg = parseInt(reg) - 1;
          var r = routine_path(D[reg]);
          var new_w = [];
          var pri = 1;
          for (var i = 0; i < r.length; i++) {
            new_w.push({
              'waste_id': (r[i] + 15 * reg).toString(),
              'latitude': WASTE[reg][r[i]][1].toString(),
              'longtitude': WASTE[reg][r[i]][2].toString(),
              'zone_id': reg.toString(),
              'priority': pri.toString()
            });
            pri++;
          }
          $.ajax(
            {
              url: "https://api.mlab.com/api/1/databases/skydefender/collections/sky/" + receiver + "?apiKey=L3tVr3ypZdG3UXlyiek9YP3bZqbBQexR",
              data: JSON.stringify(
                {
                  "$set": {
                    "waste_list": new_w
                  }
                }
              ),
              type: "PUT",
              contentType: "application/json",
              success: function(result) {
                alert('Job successfully assigned!');
              },
              error: function(error) {
                alert('Fail');
              }
            }
          );
        }
        else {
          var reg = parseInt($('#region_num').val()) - 1;
          var receiver = $('#job_r').val();
          var waste_number = parseInt($('#waste_id').val());
          var index = waste_number - 15 * reg;
          var limit = $('#deadline').val();
          $.ajax(
            {
              url: "https://api.mlab.com/api/1/databases/skydefender/collections/sky/" + receiver + "?apiKey=L3tVr3ypZdG3UXlyiek9YP3bZqbBQexR",
              method: 'GET',
              success: function(result) {
                var current_waste = result['waste_list'];
                var current_path = [];
                for (var i = 0; i < current_waste.length; i++) {
                  current_path.push(parseInt(current_waste[i]['waste_id']));
                }
                for (var q = 0; q < 1; q++) {
                  (function() {
                    routine_path_3(current_path, waste_number, limit);
                  })(q)
                }
                var timer_2 = setInterval(
                  function() {
                    if (sessionStorage.getItem('newPath') !== null) {
                      clearInterval(timer_2);
                      var text_path = sessionStorage.getItem('newPath');
                      sessionStorage.setItem('newPath', null);
                      var text_path = text_path.split(',');
                      var new_path = [];
                      var pri_2 = 1;
                      for (var j = 0; j < text_path.length; j++) {
                        new_path.push({
                          'waste_id': text_path[j],
                          'latitude': WASTE[Math.floor(parseInt(text_path[j]) / 15)][parseInt(text_path[j]) % 15][1].toString(),
                          'longtitude': WASTE[Math.floor(parseInt(text_path[j]) / 15)][parseInt(text_path[j]) % 15][2].toString(),
                          'zone_id': (Math.floor(parseInt(text_path[j]) / 15)).toString(),
                          'priority': pri_2.toString()
                        });
                        pri_2++;
                      }
                      $.ajax(
                        {
                          url: "https://api.mlab.com/api/1/databases/skydefender/collections/sky/" + receiver + "?apiKey=L3tVr3ypZdG3UXlyiek9YP3bZqbBQexR",
                          data: JSON.stringify(
                            {
                              "$set": {
                                "waste_list": new_path
                              }
                            }
                          ),
                          type: "PUT",
                          contentType: "application/json",
                          success: function(result) {
                            alert('Job successfully assigned!');
                          },
                          error: function(error) {
                            alert('Fail');
                          }
                        }
                      );
                    }
                  },
                  500
                );
              },
              error: function(error) {
                alert('Fail');
              }
            }
          );
        }
      }
    );
  }
);

function routine_path_2(region_number, source_index, result_matrix) {  // 'region_number' is from 0 to 7.
  if (source_index === 0) {
    var source_point = UMKC;
  }
  else {
    var source_point = WASTE[region_number][source_index - 1][1].toString() + ',' + WASTE[region_number][source_index - 1][2].toString();
  }
  var query_string = 'https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&origins=' + source_point;
  query_string += '&destinations=' + UMKC;
  for (var j = 0; j < WASTE[region_number].length; j++) {
    query_string += '|' + WASTE[region_number][j][1].toString() + ',' + WASTE[region_number][j][2].toString();
  }
  query_string += '&key=AIzaSyBdQx5oWNym1RUqj57OZsD-nDGyYDUpKSk';
  $.ajax(
    {
      url: query_string,
      method: 'GET',
      dataType: 'json',
      success: function(result) {
        while (result === undefined || result === null) {}
        var elements = result['rows'][0]['elements'];
        for (var j = 0; j < elements.length; j++) {
          result_matrix[source_index][j] = elements[j]['duration']['value'];
        }
      },
      error: function(error) {
        alert('fail');
      }
    }
  );
};

function routine_path_3(path, new_id, deadline) {
  source_point = '';
  for (var i = 0; i < path.length; i++) {
    var row = Math.floor(path[i] / 15);
    source_point += i === 0 ? '' : '|';
    source_point += WASTE[row][path[i] % 15][1].toString() + ',' + WASTE[row][path[i] % 15][2].toString();
  }
  query_string = 'https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&origins=' + source_point;
  query_string += '&destinations=';
  query_string += WASTE[Math.floor(new_id / 15)][new_id % 15][1].toString() + ',' + WASTE[Math.floor(new_id / 15)][new_id % 15][2].toString();
  query_string += '&key=AIzaSyBdQx5oWNym1RUqj57OZsD-nDGyYDUpKSk';
  $.ajax(
    {
      url: query_string,
      method: 'GET',
      dataType: 'json',
      success: function(result) {
        var elements = result['rows'];
        var dist_2 = [];
        for (var j = 0; j < elements.length; j++) {
          dist_2.push(parseFloat(elements[j]['elements'][0]['duration']['value']));
          console.log('dist_2 = ' + dist_2);
        }

        // 'Sky Defender' Algorithm
        var pos = 0;
        var limit = deadline === '' ? Infinity : deadline * 60;
        for (var k = 1; k < path.length; k++) {
          if (Math.floor(path[k - 1] / 15) !== Math.floor(path[k] / 15)) {
            continue;
          }
          var theReg = Math.floor(path[k] / 15);
          var index_1 = path[k - 1] % 15, index_2 = path[k] % 15;
          var dist1 = D[theReg][index_1][index_2];
          var dist2 = dist_2[k - 1];
          if (dist2 <= dist1) {
            pos = k - 1;
            break;
          }
          if ((limit -= dist2) < 0) {
            if (k - 2 < 0) {
              alert('The job cannot be assigned to this driver!');
              return;
            }
            pos = k - 2;
            break;
          }
        }
        var new_path = '';
        for (var i = 0; i < path.length; i++) {
          new_path += path[i].toString();
          if (i === pos) {
            new_path += ',' + new_id.toString();
          }
          new_path += i === path.length - 1 ? '' : ',';
        }
        sessionStorage.setItem('newPath', new_path);
      },
      error: function(error) {
        alert('fail');
      }
    }
  );
};